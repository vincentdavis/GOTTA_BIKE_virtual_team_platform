{% load static tailwind_tags django_htmx accounts_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
  <title>{% block title %}{{ config.TEAM_NAME }}{% endblock %}</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  {% block meta_description %}
    <meta name="description" content="{{ config.META_DESCRIPTION }}">{% endblock %}
  {% if config.META_KEYWORDS %}
    <meta name="keywords" content="{{ config.META_KEYWORDS }}">{% endif %}
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  {% block og_title %}
    <meta property="og:title" content="{{ config.TEAM_NAME }}">{% endblock %}
  {% block og_description %}
    <meta property="og:description" content="{{ config.META_DESCRIPTION }}">{% endblock %}
  {% if config.OG_IMAGE_URL %}
    <meta property="og:image" content="{{ config.OG_IMAGE_URL }}">{% endif %}
  {% if site_settings.favicon %}
    <link rel="icon" type="image/png" href="{{ site_settings.favicon.url }}">
  {% else %}
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
  {% endif %}
  {% tailwind_css %}
  <script src="https://unpkg.com/htmx.org@2.0.4"
          integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+"
          crossorigin="anonymous"></script>
  {% block extra_css %}{% endblock %}
</head>

<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
<!-- Site-wide Banners (full width, above everything) -->
{% if config.SITE_ANNOUNCEMENT %}
  <div
      class="bg-primary text-primary-content text-center py-2 px-4 text-sm font-medium prose prose-sm max-w-none prose-a:text-primary-content prose-a:underline">
    {{ config.SITE_ANNOUNCEMENT|render_markdown }}
  </div>
{% endif %}
{% if user.is_authenticated and not user.is_profile_complete %}
  <div class="bg-error text-error-content py-3 px-4 text-sm font-medium">
    <div class="container mx-auto">
      <div class="flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-4">
        <div class="flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24"
               stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <span>Profile incomplete:</span>
        </div>
        <div class="flex flex-wrap items-center justify-center gap-1">
          {% with status=user.profile_completion_status %}
            {% if not status.first_name %}<span class="badge badge-outline badge-sm">First Name</span>{% endif %}
            {% if not status.last_name %}<span class="badge badge-outline badge-sm">Last Name</span>{% endif %}
            {% if not status.birth_year %}<span class="badge badge-outline badge-sm">Birth Year</span>{% endif %}
            {% if not status.gender %}<span class="badge badge-outline badge-sm">Gender</span>{% endif %}
            {% if not status.timezone %}<span class="badge badge-outline badge-sm">Timezone</span>{% endif %}
            {% if not status.country %}<span class="badge badge-outline badge-sm">Country</span>{% endif %}
            {% if not status.zwid_verified %}<span class="badge badge-outline badge-sm">Zwift Verification</span>
            {% endif %}
          {% endwith %}
        </div>
        <a href="{% url 'accounts:profile_edit' %}"
           class="btn btn-sm btn-outline border-error-content text-error-content hover:bg-error-content hover:text-error">
          Complete Profile
        </a>
      </div>
    </div>
  </div>
{% endif %}

<!-- Site Header (full width, always visible) -->
<header class="navbar bg-base-200 border-b border-base-300 sticky top-0 z-50">
  <div class="flex-none lg:hidden">
    <label for="main-drawer" class="btn btn-square btn-ghost drawer-button">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </label>
  </div>
  <div class="flex-1">
    <a href="{% url 'home' %}" class="btn btn-ghost text-xl">
      {% if config.LOGO_DISPLAY_MODE == 'logo_only' or config.LOGO_DISPLAY_MODE == 'logo_and_name' %}
        {% if site_settings.site_logo %}
          <img src="{{ site_settings.site_logo.url }}" alt="{{ config.TEAM_NAME }}" class="h-8 max-w-32 object-contain">
        {% endif %}
      {% endif %}
      {% if config.LOGO_DISPLAY_MODE == 'name_only' or config.LOGO_DISPLAY_MODE == 'logo_and_name' or not site_settings.site_logo %}
        <span>{{ config.TEAM_NAME }}</span>
      {% endif %}
    </a>
  </div>
  <div class="flex-none gap-2 px-4">
    {% block header_actions %}{% endblock %}
    {% if not user.is_authenticated %}
      <a href="{% url 'account_login' %}" class="btn btn-primary">Login</a>
    {% endif %}
    {% if user.is_authenticated %}
      <div class="flex items-center gap-3">
        <div class="text-right hidden sm:block">
          <p class="text-sm font-medium">{{ user.first_name|default:user.discord_nickname|default:user.username }}</p>
          <p class="text-xs text-base-content/60 flex items-center justify-end gap-1">
            Race Verified
            {% if user.is_race_ready %}
              <span class="badge badge-success badge-xs"></span>
            {% else %}
              <span class="badge badge-error badge-xs"></span>
            {% endif %}
          </p>
        </div>
        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button"
               class="btn btn-ghost btn-circle avatar {% if not user.discord_avatar_url %}placeholder{% endif %}">
            {% if user.discord_avatar_url %}
              <div class="w-10 rounded-full">
                <img src="{{ user.discord_avatar_url }}" alt="{{ user.username }}"/>
              </div>
            {% else %}
              <div class="bg-neutral text-neutral-content w-10 rounded-full">
                <span class="text-sm">{{ user.username|slice:":2"|upper }}</span>
              </div>
            {% endif %}
          </div>
          <ul tabindex="0"
              class="dropdown-content menu bg-base-100 rounded-box z-50 w-52 p-2 shadow-lg border border-base-300 mt-2">
            <li>
              <a href="{% url 'accounts:profile' %}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                Profile
              </a>
            </li>
            <li>
              <a href="{% url 'accounts:profile' %}#race-ready" class="flex items-center justify-between">
                                <span class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                         viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                                    </svg>
                                    Race Verified
                                </span>
                {% if user.is_race_ready %}
                  <span class="badge badge-success badge-xs"></span>
                {% else %}
                  <span class="badge badge-error badge-xs"></span>
                {% endif %}
              </a>
            </li>
            <li>
              <a href="{% url 'mfa_index' %}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                Security
              </a>
            </li>
            <li class="my-1">
              <hr class="border-base-300">
            </li>
            <li>
              <a href="{% url 'account_logout' %}" class="text-error">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                Logout
              </a>
            </li>
          </ul>
        </div>
      </div>
    {% endif %}
  </div>
</header>

<div class="drawer lg:drawer-open h-[calc(100vh-64px)]">
  <input id="main-drawer" type="checkbox" class="drawer-toggle"/>

  <!-- Main Content Area -->
  <div class="drawer-content flex flex-col bg-base-100 overflow-y-auto h-full">
    <!-- Main Content -->
    <main class="flex-1 container mx-auto px-4 py-8">
      {% if messages %}
        <div class="toast toast-top toast-end z-50" id="messages-toast">
          {% for message in messages %}
            <div
                class="alert {% if message.tags == 'error' %}alert-error{% elif message.tags == 'warning' %}alert-warning{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %} shadow-lg"
                role="alert">
              <span>{{ message }}</span>
              <button type="button" class="btn btn-ghost btn-xs" onclick="this.parentElement.remove()"
                      aria-label="Close">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          {% endfor %}
        </div>
        <script>
            // Auto-dismiss alerts after 5 seconds
            setTimeout(function () {
                var toast = document.getElementById('messages-toast');
                if (toast) {
                    toast.querySelectorAll('.alert').forEach(function (alert) {
                        alert.style.transition = 'opacity 0.5s ease-out';
                        alert.style.opacity = '0';
                        setTimeout(function () {
                            alert.remove();
                        }, 500);
                    });
                }
            }, 5000);
        </script>
      {% endif %}

      {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    {% include "footer.html" %}
  </div>

  <!-- Sidebar -->
  <div class="drawer-side z-40">
    <label for="main-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
    {% include "sidebar.html" %}
  </div>
</div>

{% block extra_js %}{% endblock %}
</body>
</html>
